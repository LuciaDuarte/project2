<div class="global-body-margin-top">


<h4 class="map-title">Find people who needs help around you</h4>


<div id="filtersSection">   
        <h6 class='filters-group container'> Filter: </h6>
        <div class="map-filters">
            <label>
            Food
            <input type="radio" value="food" onclick="setFilterNeedType(this)"  name="filterNeedType"  class="radio-button radio-button-food" >
            </label>

            <label>
            Healthcare<input type="radio" value="healthcare" onclick="setFilterNeedType(this)" name="filterNeedType"  class="radio-button radio-button-healthcare" >
            </label>

            <label>
             Hosting <input type="radio" value="hosting" onclick="setFilterNeedType(this)" name="filterNeedType"  class="radio-button radio-button-hosting" >
            </label>

            <label>
            Administrative Help <input type="radio" onclick="setFilterNeedType(this)" value="administrative" name="filterNeedType"  class="radio-button radio-button-administrative" >
            </label>

            <label>
            All  <input type="radio" value="all" onclick="setFilterNeedType(this)" name="filterNeedType" class="radio-button radio-button-all" >
            </label>
        </div>
      </div>
</div>

<div class="container-fluid global-map-group">

    <div class="profile-suggestions" >
      <div>
        Members nearby:
        <div>
          {{#each needyUsersFromDB}}
          <div class="snippet-preview">
              <!-- <img class="preview-image" src="{{image}}"> -->
              <h5> {{userName}}</h5>
              <p> Needs help for: {{userName}}</p>  
              <a href="/n-profile/{{_id}}"> See more</a>
          </div>  
          {{/each}}
        </div>
      </div> 
    </div>


{{!-- The map --}}
<div style="width:600px" class="helper-map-page-bloc" id="helperMap"></div>

</div>


<input type="hidden" id="userInput" value="{{user}}">
<input type="hidden" id="allMarkers" value="{{markers}}">




<script
      src="https://maps.googleapis.com/maps/api/js?key={{gmapKey}}&callback=initMap&libraries=&v=weekly"
      defer
    ></script>  
<script>
 

//Helper Map Initiation
let filter;
let helperMap;
let geocoder;
let googleMarkers = [];
//const infowindow = new google.maps.InfoWindow();
function initMap() {
  geocoder = new google.maps.Geocoder();
   let currentUser = JSON.parse(document.getElementById("userInput").value);
 //  const lisbon = { lat: 38.7117206, lng: -9.1264315 };

 //  const centralPoint = user.geocoding;
  helperMap = new google.maps.Map(document.getElementById('helperMap'), {
    zoom: 17,
    center: {lat: currentUser.geocoding.lat, lng: currentUser.geocoding.lng}
  })

  helperMap.style.position = "static"
}


function showMarkers() {  // markers are comming from route and it is an array
   let markers = JSON.parse(document.getElementById("allMarkers").value);
   console.log("markers", markers);

   console.log("filter", filter);

   if (filter && filter !== "all") {
     clearMarkers();
     markers = markers.filter((marker) => {
       return marker.needType.name === filter; 
     });
   }

   // add some filters based on the radio buttons checked.
  
   markers.forEach((marker) =>{
     setMarker({ lat: marker.geocoding.lat, lng: marker.geocoding.lng})
    });
 };

function setMarker(marker) {
  const googleMarker = new google.maps.Marker({
   position: marker,
    map: helperMap
  });
  googleMarkers.push(googleMarker);
 };

  function getCurrentLocation() {
    navigator.geolocation.getCurrentPosition((position) =>{
      const pos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      }
 //     console.log(pos, 'this is my position')
      helperMap = new google.maps.Map(document.getElementById('helperMap'), {
      zoom: 13,
      center: pos
     })
    })
  }


  function codeAddress() {
    var address = document.getElementById('address').value;
    geocoder.geocode( { 'address': address}, function(results, status) {
      if (status == 'OK') {
        map.setCenter(results[0].geometry.location);
        var marker = new google.maps.Marker({
            map: map,
            position: results[0].geometry.location
        });
      } else {
        alert('Geocode was not successful for the following reason: ' + status);
      }
    });
  }

function setFilterNeedType(radio){
  filter = radio.value;
  showMarkers();

}

function clearMarkers() {
  googleMarkers.forEach((googleMarker) =>{
    googleMarker.setMap(null);
  })
}

setTimeout(()=> {
  showMarkers();
},1000)

</script>

